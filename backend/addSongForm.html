<html>
    <head>
        <meta charset="UTF-8">
        <title>Add Song</title>
        <script>
            let isSubmitted = false;

            function fetchSong() {
                const content = document.getElementById('songHtmlContent').value;
                const url = document.getElementById('songUrl').value;
                if (content) {
                    fetchSongFromContent(content);
                } else if (url) {
                    const request = new XMLHttpRequest();
                    request.onreadystatechange = function () {
                        if (request.readyState === 4 && request.status === 200) {
                            fetchSongFromContent(request);
                        }
                    };
                    request.onerror = function () {
                        alert('Invalid Url!');
                    };
                    request.open('GET', 'https://cors.io/?u=' + url);
                    request.send();
                }
            }

            function fetchSongFromContent(urlContent) {
                let songText = '';
                const dom = document.createElement('div');
                dom.innerHTML = urlContent.replace(/<(img|script) [^>]+>/gi, '');
                const songBlockTop = dom.getElementsByClassName('song_block_top')[0];
                const songHeader = songBlockTop.getElementsByClassName('blackNone')[0];
                const artist = songHeader.childNodes[0].textContent.trim();
                const songName = songHeader.childNodes[1].textContent.replace(' - ', '').trim();
                const songContent = songBlockTop.getElementsByClassName('block_content_padd')[0];
                const songTables = songContent.children[3].getElementsByTagName('tbody');
                for (let index = 0; index < songTables.length; index++) {
                    const tableLines = songTables[index].getElementsByTagName('tr');
                    for (let lineIndex = 0; lineIndex < tableLines.length - 1; lineIndex += 2) {
                        const chordsPart = tableLines[lineIndex].getElementsByClassName('chords_en')[0];
                        const textPart = tableLines[lineIndex + 1].getElementsByClassName('song')[0];
                        if (chordsPart && textPart) {
                            const spacesRegex = /(&nbsp;)+/g;
                            const chords = chordsPart.getElementsByTagName('span');
                            let text = textPart.textContent;
                            let spaces = '';
                            let chordIndex = 0;
                            let chordTextPosition = 0;
                            while (chords.length > chordIndex && (spaces = spacesRegex.exec(chordsPart.innerHTML))) {
                                let chord = chords[chordIndex].textContent;
                                if (chordIndex === 0 && spaces.index > 0) {
                                    // The first chord is in the beginning of the line.
                                    text = '[' + chord + ']' + text;
                                    chordTextPosition += (2 + 2 * chord.length);
                                    chordIndex++;
                                    chord = chords[chordIndex].textContent;
                                }
                                chordTextPosition += (spaces[0].length / 6);
                                text = text.slice(0, chordTextPosition) + '[' + chord + ']' + text.slice(chordTextPosition);
                                chordTextPosition += (2 + 2 * chord.length);
                                chordIndex++;
                            }
                            songText += text + '\n';
                        }
                    }
                }

                const songNameElement = document.getElementById('songName');
                const artistNameElement = document.getElementById('artistName');
                const avatarImageElement = document.getElementById('avatarImage');
                const coverImageElement = document.getElementById('coverImage');
                const lyricsElement = document.getElementById('lyrics');
                songNameElement.value = songName;
                artistNameElement.value = artist;
                lyricsElement.value = songText;
                const images = JSON.parse(localStorage.getItem(artist) || '{}');
                avatarImageElement.value = images.avatarImage || '';
                coverImageElement.value = images.coverImage || '';
            }

            function onResultsFrameLoad() {
                if (isSubmitted) {
                    const songName = document.getElementById('songName');
                    const artistName = document.getElementById('artistName');
                    const avatarImage = document.getElementById('avatarImage');
                    const coverImage = document.getElementById('coverImage');
                    const lyrics = document.getElementById('lyrics');

                    // check if song submitted successfully.
                    if (songName.value.trim() && artistName.value.trim() && lyrics.value.trim()) {
                        if (coverImage.value || avatarImage.value) {
                            const images = JSON.parse(localStorage.getItem(artistName.value) || '{}');
                            images.avatarImage = avatarImage.value;
                            images.coverImage = coverImage.value;
                            localStorage.setItem(artistName.value, JSON.stringify(images));
                        }
                        songName.value = '';
                        artistName.value = '';
                        avatarImage.value = '';
                        coverImage.value = '';
                        lyrics.value = '';
                        document.getElementById('songHtmlContent').value = '';
                        document.getElementById('songUrl').value = '';
                    }
                    isSubmitted = false;
                    document.getElementById('uploadingFrame').style.display = 'none';
                    document.getElementById('resultsFrame').style.display = 'block';
                    document.getElementById("submitSongButton").disabled = false;
                }
            }

            function onSubmitSong() {
                isSubmitted = true;
                document.getElementById('uploadingFrame').style.display = 'block';
                document.getElementById('resultsFrame').style.display = 'none';
                document.getElementById("submitSongButton").disabled = true;
            }
        </script>
        <style>
            .input-style {
                width: 500px;
                height: 25px;
                font-size: 16px;
            }

            .text-area-style {
                font-size: 16px;
                width: 800px;
            }

            .submit-button {
                font-size: 24px;
                color: white;
                padding: 10px;
                margin-bottom: 20px;
                background-color: #093;
            }

            #resultsFrame {
                display: block;
                width: 800px;
                height: 50px;
                outline: none;
                border: none;
            }

            #uploadingFrame {
                display: none;
                width: 800px;
                height: 50px;
            }
        </style>
    </head>
    <body>
        <label for="songUrl">Song url:</label>
        <input id="songUrl" type="text" name="url" class="input-style">
        <br><br>
        <label for="songHtmlContent">Song html content:</label><br>
        <textarea id="songHtmlContent" name="songHtmlContent" rows="2" class="text-area-style"></textarea>
        <br><br>
        <button class="submit-button" onclick="fetchSong()">Fetch Song</button>
        <form method="post"
              target="resultsFrame"
              action="https://us-central1-singalong-6aaf5.cloudfunctions.net/addSong"
              onsubmit="onSubmitSong()">

            <label for="songName">Song name:</label>
            <input id="songName" type="text" name="name" class="input-style">
            <br><br>
            <label for="artistName">Artist name:</label>
            <input id="artistName" type="text" name="artist" class="input-style">
            <br><br>
            <label for="avatarImage">Avatar image:</label>
            <input id="avatarImage" type="text" name="image" class="input-style">
            <br><br>
            <label for="coverImage">Cover image (optional):</label>
            <input id="coverImage" type="text" name="coverImage" class="input-style">
            <br><br>
            <label for="lyrics">Lyrics:</label><br>
            <textarea id="lyrics" name="lyrics" rows="20" class="text-area-style"></textarea>
            <br><br>
            <div id="uploadingFrame">uploading...</div>
            <iframe name="resultsFrame" id="resultsFrame" onload="onResultsFrameLoad(event)"></iframe>
            <input id="submitSongButton" type="submit" value="Submit" class="submit-button">
        </form>
    </body>
</html>